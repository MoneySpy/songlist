<!doctype html>
<html lang="th">
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<title>ระบบขอเพลง - สำหรับพนักงาน</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="icon" href="favicon.ico" type="image/x-icon"/>		
		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap">
		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
		<!-- Animate.css -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
		<!-- Custom CSS -->
		<link rel="stylesheet" href="style.css">
	</head>
	<body>
		<!-- Animated Background -->
		<div class="animated-background">
			<div class="particles"></div>
			<div class="floating-notes">
				<div class="note note-1">♪</div>
				<div class="note note-2">♫</div>
				<div class="note note-3">♬</div>
				<div class="note note-4">♩</div>
				<div class="note note-5">♪</div>
				<div class="note note-6">♫</div>
			</div>
		</div>

		<div class="container-fluid">
			<!-- Header -->
			<div class="main-header animate__animated animate__fadeInDown">
				<div class="header-content">
					<div class="header-icon animate__animated animate__pulse animate__infinite">
						<i class="fas fa-music"></i>
					</div>
					<h1 class="animate__animated animate__fadeInUp">ระบบขอเพลง</h1>
					<p id='time' class="animate__animated animate__fadeInUp animate__delay-1s"></p>
				</div>
			</div>

			<div class="row">
				<!-- ฟอร์มขอเพลง -->
				<div class="col-lg-4 col-md-6">
					<div class="request-form-container animate__animated animate__fadeInLeft">
						<div class="form-header">
							<div class="form-icon animate__animated animate__bounceIn animate__delay-1s">
								<i class="fas fa-plus-circle"></i>
							</div>
							<h2>ขอเพลงใหม่</h2>
							<p class="subtitle">สำหรับพนักงาน</p>
						</div>
						
						<form id="songRequestForm" class="request-form">
							<div class="form-group animate__animated animate__fadeInUp animate__delay-1s">
								<label for="songTitle">
									<i class="fas fa-headphones"></i> ชื่อเพลง *
								</label>
								<input type="text" class="form-control" id="songTitle" name="songTitle" required placeholder="กรอกชื่อเพลง">
								<div class="input-focus-effect"></div>
							</div>
							
							<div class="form-group animate__animated animate__fadeInUp animate__delay-2s">
								<label for="artist">
									<i class="fas fa-user"></i> ศิลปิน *
								</label>
								<input type="text" class="form-control" id="artist" name="artist" required placeholder="กรอกชื่อศิลปิน">
								<div class="input-focus-effect"></div>
							</div>
							
							<div class="form-group animate__animated animate__fadeInUp animate__delay-3s">
								<label for="requesterName">
									<i class="fas fa-user-friends"></i> ผู้ขอ *
								</label>
								<input type="text" class="form-control" id="requesterName" name="requesterName" required placeholder="กรอกชื่อผู้ขอ">
								<div class="input-focus-effect"></div>
							</div>
							
							<div class="form-actions animate__animated animate__fadeInUp animate__delay-4s">
								<button type="submit" class="btn btn-primary btn-lg btn-block submit-btn">
									<i class="fas fa-paper-plane"></i> ส่งคำขอเพลง
									<div class="btn-ripple"></div>
								</button>
								<button type="button" class="btn btn-secondary btn-lg btn-block mt-2" onclick="clearForm()">
									<i class="fas fa-eraser"></i> ล้างฟอร์ม
								</button>
							</div>
						</form>
					</div>
				</div>

				<!-- สถิติและรายการเพลง -->
				<div class="col-lg-8 col-md-6">
					<!-- สถิติประจำวัน/สัปดาห์/เดือน -->
					<div class="stats-container animate__animated animate__fadeInRight">
						<div class="stats-header">
							<div class="stats-icon animate__animated animate__rotateIn animate__delay-1s">
								<i class="fas fa-chart-bar"></i>
							</div>
							<h3>สถิติการขอเพลง</h3>
						</div>
						<div class="row">
							<div class="col-md-4 col-12">
								<div class="stat-card animate__animated animate__zoomIn animate__delay-1s">
									<div class="stat-icon daily animate__animated animate__pulse animate__infinite">
										<i class="fas fa-calendar-day"></i>
									</div>
									<div class="stat-content">
										<div class="stat-number" id="dailyCount">0</div>
										<div class="stat-label">วันนี้</div>
									</div>
									<div class="stat-glow"></div>
								</div>
							</div>
							<div class="col-md-4 col-12">
								<div class="stat-card animate__animated animate__zoomIn animate__delay-2s">
									<div class="stat-icon weekly animate__animated animate__pulse animate__infinite">
										<i class="fas fa-calendar-week"></i>
									</div>
									<div class="stat-content">
										<div class="stat-number" id="weeklyCount">0</div>
										<div class="stat-label">สัปดาห์นี้</div>
									</div>
									<div class="stat-glow"></div>
								</div>
							</div>
							<div class="col-md-4 col-12">
								<div class="stat-card animate__animated animate__zoomIn animate__delay-3s">
									<div class="stat-icon monthly animate__animated animate__pulse animate__infinite">
										<i class="fas fa-calendar-alt"></i>
									</div>
									<div class="stat-content">
										<div class="stat-number" id="monthlyCount">0</div>
										<div class="stat-label">เดือนนี้</div>
									</div>
									<div class="stat-glow"></div>
								</div>
							</div>
						</div>
					</div>

					<!-- Top 10 ผู้ขอ -->
					<div class="top-requesters-container animate__animated animate__fadeInRight animate__delay-1s">
						<div class="top-header">
							<div class="trophy-icon animate__animated animate__tada animate__infinite">
								<i class="fas fa-trophy"></i>
							</div>
							<h3>Top 10 ผู้ขอเพลง</h3>
						</div>
						<div class="top-requesters-list" id="topRequestersList">
							<!-- รายการ Top 10 จะถูกเพิ่มที่นี่ -->
						</div>
					</div>
				</div>
			</div>

			<!-- รายการเพลงที่ขอ -->
			<div class="row mt-4">
				<div class="col-12">
					<div class="song-list-container animate__animated animate__fadeInUp animate__delay-2s">
						<div class="list-header">
							<div class="row">
								<div class="col-md-6 col-12">
									<div class="list-title">
										<div class="list-icon animate__animated animate__bounceIn animate__delay-1s">
											<i class="fas fa-list"></i>
										</div>
										<h3>รายการเพลงที่ขอ</h3>
									</div>
								</div>
								<div class="col-md-6 col-12 text-right">
									<span class="song-count" id="songCount">0 เพลง</span>
								</div>
							</div>
						</div>
						
						<div class="song-list" id="songList">
							<!-- รายการเพลงจะถูกเพิ่มที่นี่ -->
						</div>
						
						<div class="list-footer">
							<div class="auto-scroll-info">
								<i class="fas fa-info-circle animate__animated animate__pulse animate__infinite"></i> 
								รายการจะเลื่อนอัตโนมัติเมื่อมีเพลงใหม่
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- ปุ่ม Export ข้อมูล -->
			<div class="mt-3 mb-3">
				<button id="exportTxtBtn" class="btn btn-info btn-sm mr-2"><i class="fas fa-download"></i> ดาวน์โหลด .txt</button>
				<button id="exportCsvBtn" class="btn btn-success btn-sm mr-2"><i class="fas fa-file-csv"></i> ดาวน์โหลด .csv</button>
				<button id="exportJsonBtn" class="btn btn-warning btn-sm"><i class="fas fa-file-code"></i> ดาวน์โหลด .json</button>
			</div>
		</div>

		<!-- Loading Overlay -->
		<div class="loading-overlay" id="loadingOverlay">
			<div class="loading-content">
				<div class="loading-spinner">
					<i class="fas fa-music animate__animated animate__spin animate__infinite"></i>
				</div>
				<p>กำลังโหลดข้อมูล...</p>
			</div>
		</div>
			
		<!-- jQuery first, then Popper.js, then Bootstrap JS -->
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
		
		<!-- Firebase SDKs -->
		<script src="https://www.gstatic.com/firebasejs/7.15.3/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/7.15.3/firebase-auth.js"></script>
		<script src="https://www.gstatic.com/firebasejs/7.15.3/firebase-database.js"></script>
		
		<script>
			// Your web app's Firebase configuration
			var firebaseConfig = {
				apiKey: "AIzaSyBG0DUbhjeCqVNH18c360fXMnF-tuVljMc",
				authDomain: "request-song-7201b.firebaseapp.com",
				databaseURL: "https://request-song-7201b-default-rtdb.firebaseio.com",
				projectId: "request-song-7201b",
				storageBucket: "request-song-7201b.appspot.com",
				messagingSenderId: "15360790179",
				appId: "1:15360790179:web:af3db16d01b43c20c63916",
				measurementId: "G-TY3BCCPFRZ"
			};
			// Initialize Firebase
			firebase.initializeApp(firebaseConfig);
		</script>
		
		<script>
			// get a new date (locale machine date time)
			let current_datetime = new Date()
			let formatted_date = current_datetime.getDate() + "-" + (current_datetime.getMonth() + 1) + "-" + current_datetime.getFullYear()
			document.getElementById('time').innerHTML = 'รายการขอเพลงประจำวันที่ : ' + formatted_date;
			
			let songCount = 0;
			let autoScrollEnabled = true;
			
			// 1. สร้างตัวแปร global สำหรับ mock data
			let mockSongs = [
				{ SongTitle: "รักเดียว", Artist: "ปู พงษ์สิทธิ์", Name: "สมชาย", status: "pending", key: "1" },
				{ SongTitle: "ขอใจเธอแลกเบอร์โทร", Artist: "หญิงลี", Name: "สมหญิง", status: "completed", key: "2" }
			];

			$(document).ready(function(){
				// ซ่อน loading overlay
				setTimeout(() => {
					$('#loadingOverlay').fadeOut();
				}, 2000);
				
				loadSongList();
				loadStatistics();
				loadTopRequesters();
				setupRealTimeUpdates();
				
				// จัดการการส่งฟอร์ม
				$('#songRequestForm').on('submit', function(e){
					e.preventDefault();
					submitSongRequest();
				});
				
				// เพิ่ม animation ให้กับ input fields
				$('.form-control').on('focus', function() {
					$(this).parent().addClass('focused');
				}).on('blur', function() {
					if (!$(this).val()) {
						$(this).parent().removeClass('focused');
					}
				});
				
				// เพิ่ม ripple effect ให้กับปุ่ม
				$('.submit-btn').on('click', function(e) {
					const btn = $(this);
					const ripple = btn.find('.btn-ripple');
					
					const x = e.pageX - btn.offset().left;
					const y = e.pageY - btn.offset().top;
					
					ripple.css({
						left: x + 'px',
						top: y + 'px'
					});
					
					ripple.addClass('ripple-active');
					
					setTimeout(() => {
						ripple.removeClass('ripple-active');
					}, 600);
				});

				// Export TXT
				$('#exportTxtBtn').on('click', function() {
					let txt = 'ชื่อเพลง\tศิลปิน\tผู้ขอ\tสถานะ\tเวลา\n';
					mockSongs.forEach(song => {
						txt += `${song.SongTitle}\t${song.Artist}\t${song.Name}\t${song.status || ''}\t${song.timestamp || ''}\n`;
					});
					const blob = new Blob([txt], { type: 'text/plain' });
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = 'songlist.txt';
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					URL.revokeObjectURL(url);
				});

				// Export CSV
				$('#exportCsvBtn').on('click', function() {
					let csv = 'ชื่อเพลง,ศิลปิน,ผู้ขอ,สถานะ,เวลา\n';
					mockSongs.forEach(song => {
						// Escape comma and quote
						const row = [song.SongTitle, song.Artist, song.Name, song.status || '', song.timestamp || '']
							.map(val => '"' + (val ? val.replace(/"/g, '""') : '') + '"').join(',');
						csv += row + '\n';
					});
					const blob = new Blob([csv], { type: 'text/csv' });
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = 'songlist.csv';
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					URL.revokeObjectURL(url);
				});

				// Export JSON
				$('#exportJsonBtn').on('click', function() {
					const json = JSON.stringify(mockSongs, null, 2);
					const blob = new Blob([json], { type: 'application/json' });
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = 'songlist.json';
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					URL.revokeObjectURL(url);
				});
			});
			
			function submitSongRequest() {
				const songTitle = $('#songTitle').val().trim();
				const artist = $('#artist').val().trim();
				const requesterName = $('#requesterName').val().trim();

				if (!songTitle || !artist || !requesterName) {
					showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
					return;
				}

				$('.submit-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> กำลังส่ง...');

				// เพิ่มเพลงใหม่เข้า mockSongs พร้อม timestamp
				mockSongs.push({
					SongTitle: songTitle,
					Artist: artist,
					Name: requesterName,
					status: "pending",
					key: (mockSongs.length + 1).toString(),
					timestamp: new Date().toISOString()
				});

				setTimeout(() => {
					showNotification('ส่งคำขอเพลงเรียบร้อยแล้ว!', 'success');
					clearForm();
					loadSongList();
					loadStatistics();
					loadTopRequesters();
					$('.submit-btn').prop('disabled', false).html('<i class="fas fa-paper-plane"></i> ส่งคำขอเพลง');
				}, 500);
			}
			
			function clearForm() {
				$('#songRequestForm')[0].reset();
				$('.form-group').removeClass('focused');
			}
			
			function loadSongList() {
				$('#songList').empty();
				// เรียงจากใหม่ไปเก่า (timestamp ล่าสุดก่อน)
				const sorted = [...mockSongs].sort((a, b) => {
					const tA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
					const tB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
					return tB - tA;
				});
				// เอาแค่ 10 เพลงล่าสุด
				const now = Date.now();
				sorted.slice(0, 10).forEach(song => {
					// ถ้า timestamp เกิน 5 นาที ให้เปลี่ยนสถานะเป็น 'เล่นแล้ว'
					if (song.timestamp) {
						const diff = now - new Date(song.timestamp).getTime();
						if (diff > 5 * 60 * 1000) {
							song.status = 'completed';
						}
					}
					addSongToList(song);
				});
				songCount = Math.min(sorted.length, 10);
				updateSongCount();
			}
			
			function addSongToList(song) {
				const songHtml = `
					<div class="song-item animate__animated animate__fadeInUp" data-key="${song.key}">
						<div class="song-cover animate__animated animate__bounceIn">
							<i class="fas fa-music"></i>
						</div>
						<div class="song-details">
							<div class="song-title">${song.SongTitle}</div>
							<div class="song-artist">${song.Artist}</div>
							<div class="song-customer">
								<i class="fas fa-user"></i> ${song.Name}
							</div>
						</div>
						<div class="song-amount">
							<div class="song-status">
								<span class="status-badge status-${song.status || 'pending'} animate__animated animate__pulse">
									${getStatusText(song.status || 'pending')}
								</span>
							</div>
						</div>
					</div>
				`;
				
				$('#songList').append(songHtml);
				// ไม่ต้องเพิ่ม songCount++ ที่นี่
			}
			
			function getStatusText(status) {
				switch(status) {
					case 'pending': return 'รอเล่น';
					case 'playing': return 'กำลังเล่น';
					case 'completed': return 'เล่นแล้ว';
					default: return 'รอเล่น';
				}
			}
			
			function updateSongCount() {
				$('#songCount').text(songCount + ' เพลง');
			}
			
			function loadStatistics() {
				const now = new Date();
				const todayStr = now.toISOString().slice(0, 10);

				// Helper: เช็คว่าสัปดาห์เดียวกันไหม
				function isSameWeek(date1, date2) {
					const d1 = new Date(date1);
					const d2 = new Date(date2);
					const day1 = d1.getDay() || 7;
					const day2 = d2.getDay() || 7;
					d1.setHours(0,0,0,0);
					d2.setHours(0,0,0,0);
					d1.setDate(d1.getDate() - day1 + 1);
					d2.setDate(d2.getDate() - day2 + 1);
					return d1.getTime() === d2.getTime();
				}

				// Helper: เช็คว่าเดือนเดียวกันไหม
				function isSameMonth(date1, date2) {
					const d1 = new Date(date1);
					const d2 = new Date(date2);
					return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth();
				}

				let daily = 0, weekly = 0, monthly = 0;
				mockSongs.forEach(song => {
					// ถ้าไม่มี timestamp ให้ถือว่าเป็นวันนี้
					let songDate = song.timestamp ? new Date(song.timestamp) : now;
					let songDateStr = songDate.toISOString().slice(0, 10);
					if (songDateStr === todayStr) daily++;
					if (isSameWeek(songDate, now)) weekly++;
					if (isSameMonth(songDate, now)) monthly++;
				});
				$('#dailyCount').text(daily);
				$('#weeklyCount').text(weekly);
				$('#monthlyCount').text(monthly);
			}
			
			function animateCounters() {
				$('.stat-number').each(function() {
					const $this = $(this);
					const countTo = parseInt($this.text());
					
					$({ countNum: 0 }).animate({
						countNum: countTo
					}, {
						duration: 1000,
						easing: 'swing',
						step: function() {
							$this.text(Math.floor(this.countNum));
						},
						complete: function() {
							$this.text(this.countNum);
						}
					});
				});
			}
			
			function getWeekStart() {
				const now = new Date();
				const dayOfWeek = now.getDay();
				const diff = now.getDate() - dayOfWeek;
				const weekStart = new Date(now.setDate(diff));
				return weekStart.toISOString().slice(0,10);
			}
			
			function getMonthStart() {
				const now = new Date();
				return new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10);
			}
			
			function loadTopRequesters() {
				// นับจำนวนการขอเพลงของแต่ละคน (เฉพาะเดือนนี้) และเก็บเวลาขอล่าสุด
				const now = new Date();
				const requesters = {};
				mockSongs.forEach(song => {
					let songDate = song.timestamp ? new Date(song.timestamp) : now;
					if (songDate.getFullYear() === now.getFullYear() && songDate.getMonth() === now.getMonth()) {
						const name = song.Name;
						if (!requesters[name]) {
							requesters[name] = { count: 0, last: songDate };
						}
						requesters[name].count++;
						// ถ้าเวลานี้ใหม่กว่า last เดิม ให้เก็บเป็น last
						if (songDate > requesters[name].last) {
							requesters[name].last = songDate;
						}
					}
				});
				// เรียงลำดับมากไปน้อย เอาแค่ 10 อันดับแรก
				const sorted = Object.entries(requesters)
					.sort((a, b) => b[1].count - a[1].count)
					.slice(0, 10);
				$('#topRequestersList').empty();
				if (sorted.length === 0) {
					$('#topRequestersList').html('<div class="no-data animate__animated animate__fadeIn">ยังไม่มีข้อมูลผู้ขอ</div>');
					return;
				}
				sorted.forEach(([name, info], index) => {
					const rank = index + 1;
					const rankClass = rank <= 3 ? `rank-${rank}` : '';
					// ฟอร์แมตเวลา
					const last = info.last;
					const nowDate = new Date();
					let timeStr = '';
					if (last.toDateString() === nowDate.toDateString()) {
						// วันนี้ แสดง HH:mm:ss
						timeStr = last.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
					} else {
						// วันอื่น แสดง dd/MM/yyyy HH:mm
						timeStr = last.toLocaleDateString('th-TH') + ' ' + last.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
					}
					const html = `
						<div class="requester-item ${rankClass} animate__animated animate__fadeInLeft">
							<div class="requester-rank"><span class="rank-number">${rank}</span></div>
							<div class="requester-info">
								<div class="requester-name">${name}</div>
								<div class="requester-time" style="font-size:12px;color:#888;">ล่าสุด: ${timeStr}</div>
							</div>
							<div class="requester-count"><span class="count-badge animate__animated animate__pulse animate__infinite">${info.count} ครั้ง</span></div>
						</div>
					`;
					$('#topRequestersList').append(html);
				});
			}
			
			function setupRealTimeUpdates() {
				const todayDate = new Date().toISOString().slice(0,10);
				const songlistRef = firebase.database().ref('song_list');
				
				songlistRef.orderByChild("todayDate").equalTo(todayDate).on("child_added", function(data) {
					const song = {
						key: data.key,
						...data.val()
					};
					
					// ตรวจสอบว่าเพลงนี้มีอยู่แล้วหรือไม่
					if (!$(`[data-key="${song.key}"]`).length) {
						addSongToList(song);
						updateSongCount();
						loadStatistics();
						loadTopRequesters();
					}
				});
			}
			
			function showNotification(message, type) {
				const notification = $(`
					<div class="notification notification-${type} animate__animated animate__fadeInRight">
						<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
						<span>${message}</span>
					</div>
				`);
				
				$('body').append(notification);
				
				setTimeout(() => {
					notification.addClass('animate__fadeOutRight');
					setTimeout(() => {
						notification.remove();
					}, 500);
				}, 3000);
			}
			
			// อัพเดทข้อมูลทุก 30 วินาที
			setInterval(() => {
				loadSongList();
				loadStatistics();
				loadTopRequesters();
			}, 30000);
		</script>
	</body>
</html>			
